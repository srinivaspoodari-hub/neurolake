---
# Horizontal Pod Autoscaler for API Service
# Scales based on CPU and memory utilization
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neurolake-api-hpa
  namespace: neurolake
  labels:
    app.kubernetes.io/name: neurolake
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: neurolake
spec:
  # Reference to the deployment to scale
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neurolake-api

  # Replica bounds
  minReplicas: 3
  maxReplicas: 10

  # Scaling behavior
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 minutes before scaling down
      policies:
        - type: Percent
          value: 50  # Scale down max 50% of current pods
          periodSeconds: 60
        - type: Pods
          value: 2   # Scale down max 2 pods at a time
          periodSeconds: 60
      selectPolicy: Min  # Use the policy that scales down the least

    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
        - type: Percent
          value: 100  # Scale up max 100% (double) of current pods
          periodSeconds: 30
        - type: Pods
          value: 4    # Scale up max 4 pods at a time
          periodSeconds: 30
      selectPolicy: Max  # Use the policy that scales up the most

  # Metrics to scale on
  metrics:
    # CPU utilization
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70  # Target 70% CPU utilization

    # Memory utilization
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80  # Target 80% memory utilization

    # Custom metric: requests per second (requires metrics-server and adapter)
    # Uncomment if using custom metrics
    # - type: Pods
    #   pods:
    #     metric:
    #       name: http_requests_per_second
    #     target:
    #       type: AverageValue
    #       averageValue: "1000"

---
# HPA for Frontend Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neurolake-frontend-hpa
  namespace: neurolake
  labels:
    app.kubernetes.io/name: neurolake
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: neurolake
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neurolake-frontend

  minReplicas: 2
  maxReplicas: 8

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 1
          periodSeconds: 60
      selectPolicy: Min

    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 3
          periodSeconds: 30
      selectPolicy: Max

  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75

    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# HPA for Worker Pods (if using Celery or similar)
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neurolake-worker-hpa
  namespace: neurolake
  labels:
    app.kubernetes.io/name: neurolake
    app.kubernetes.io/component: worker
    app.kubernetes.io/part-of: neurolake
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neurolake-worker

  minReplicas: 2
  maxReplicas: 20  # Workers can scale higher for background jobs

  behavior:
    scaleDown:
      stabilizationWindowSeconds: 600  # Wait longer for workers (10 min)
      policies:
        - type: Percent
          value: 25  # Scale down more conservatively
          periodSeconds: 120
        - type: Pods
          value: 2
          periodSeconds: 120
      selectPolicy: Min

    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15  # Scale up faster for workers
        - type: Pods
          value: 5
          periodSeconds: 15
      selectPolicy: Max

  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60  # Lower threshold for workers

    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75

    # Queue depth metric (requires custom metrics)
    # - type: External
    #   external:
    #     metric:
    #       name: celery_queue_depth
    #       selector:
    #         matchLabels:
    #           queue: default
    #     target:
    #       type: AverageValue
    #       averageValue: "50"

---
# HPA with External Metrics (example using Prometheus adapter)
# Uncomment and configure if using Prometheus metrics
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: neurolake-api-advanced-hpa
#   namespace: neurolake
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: neurolake-api
#
#   minReplicas: 3
#   maxReplicas: 15
#
#   metrics:
#     # CPU
#     - type: Resource
#       resource:
#         name: cpu
#         target:
#           type: Utilization
#           averageUtilization: 70
#
#     # Custom: HTTP request rate
#     - type: Pods
#       pods:
#         metric:
#           name: http_requests_per_second
#         target:
#           type: AverageValue
#           averageValue: "1000"
#
#     # Custom: HTTP latency (p95)
#     - type: Pods
#       pods:
#         metric:
#           name: http_request_duration_p95
#         target:
#           type: AverageValue
#           averageValue: "500m"  # 500ms
#
#     # External: Database connection pool
#     - type: External
#       external:
#         metric:
#           name: postgres_connection_pool_usage
#           selector:
#             matchLabels:
#               database: neurolake
#         target:
#           type: AverageValue
#           averageValue: "0.7"  # 70% pool usage
#
#     # External: Redis queue depth
#     - type: External
#       external:
#         metric:
#           name: redis_queue_length
#           selector:
#             matchLabels:
#               queue: tasks
#         target:
#           type: AverageValue
#           averageValue: "100"

---
# HPA for Scheduled/Batch Jobs (CronJob pods)
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: neurolake-batch-hpa
#   namespace: neurolake
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: neurolake-batch-processor
#
#   minReplicas: 0  # Can scale to zero when no work
#   maxReplicas: 10
#
#   behavior:
#     scaleDown:
#       stabilizationWindowSeconds: 300
#       policies:
#         - type: Pods
#           value: 1
#           periodSeconds: 60
#
#     scaleUp:
#       stabilizationWindowSeconds: 0
#       policies:
#         - type: Percent
#           value: 100
#           periodSeconds: 15
#         - type: Pods
#           value: 3
#           periodSeconds: 15
#       selectPolicy: Max
#
#   metrics:
#     - type: External
#       external:
#         metric:
#           name: job_queue_depth
#         target:
#           type: AverageValue
#           averageValue: "10"  # Scale when avg 10 jobs per pod
