# NeuroLake Unified Dashboard - Dockerfile
# Integrates all completed MVP features into a single web interface

FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt requirements-dev.txt* ./

# Install Python dependencies
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0 \
    psycopg2-binary==2.9.9 \
    minio==7.2.0 \
    redis==5.0.1 \
    python-multipart==0.0.20 \
    numpy==1.26.0 \
    pyyaml==6.0.1 \
    pandas==2.1.3 \
    sqlparse==0.4.4 \
    msgpack==1.1.0 \
    zstandard==0.22.0 \
    anthropic==0.72.0 \
    && pip install --no-cache-dir -r requirements.txt || true

# Copy NeuroLake Python package
COPY neurolake/ ./neurolake/
COPY pyproject.toml ./
COPY setup.py* ./

# Install NeuroLake package in editable mode
RUN pip install --no-cache-dir -e . || echo "Warning: Could not install neurolake package"

# Copy unified dashboard application and migration UI
COPY advanced_databricks_dashboard.py ./
COPY migration_ui.html ./
COPY migration_module/ ./migration_module/

# Copy notebook system files
COPY neurolake_notebook_system.py ./
COPY notebook_advanced_features.py ./
COPY notebook_api_endpoints.py ./
COPY notebook_ui.html ./
COPY notebook_export.py* ./
COPY notebook_*.py* ./

# Expose dashboard port
EXPOSE 5000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5000/health || exit 1

# Run advanced Databricks-like dashboard with ALL features
CMD ["python", "advanced_databricks_dashboard.py"]
